FROM python:3.11-slim

ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
WORKDIR /app

RUN pip install --no-cache-dir pytest

# COPY MÁS EXPLÍCITO - ANTES del main.py
COPY src/__init__.py src/
COPY src/protocol.py src/
COPY src/storage.py src/
COPY src/overlay.py src/
COPY src/networking.py src/
COPY main.py ./

# VERIFICACIÓN CRÍTICA
RUN python -c "from src.protocol import Message, MessageType; print('✅ PROTOCOL OK')" || (echo "❌ PROTOCOL FAIL" && exit 1)
RUN ls -la src/ && echo "✅ BUILD OK"

CMD ["python", "main.py"]
